dist: xenial
language: generic

services:
- docker

matrix:
  include:
  - env: PYTHON_VERSION=2 PYTHONIC=no  SYMPY_VER=1.2 OCT=4.2   DOCTEST=yes COLUMNS=80
  - env: PYTHON_VERSION=3 PYTHONIC=no  SYMPY_VER=1.2 OCT=4.2   DOCTEST=yes COLUMNS=80
  - env: PYTHON_VERSION=3 PYTHONIC=no  SYMPY_VER=1.2 OCT=4.4   DOCTEST=yes COLUMNS=80
  - env: PYTHON_VERSION=3 PYTHONIC=no  SYMPY_VER=1.2 OCT=5     DOCTEST=yes COLUMNS=80
  - env: PYTHON_VERSION=3 PYTHONIC=no  SYMPY_VER=1.3 OCT=4.2   DOCTEST=yes COLUMNS=80
  - env: PYTHON_VERSION=2 PYTHONIC=no  SYMPY_VER=1.3 OCT=4.4   DOCTEST=yes COLUMNS=80
  - env: PYTHON_VERSION=3 PYTHONIC=no  SYMPY_VER=1.3 OCT=4.4   DOCTEST=yes COLUMNS=80
  - env: PYTHON_VERSION=3 PYTHONIC=no  SYMPY_VER=1.3 OCT=5     DOCTEST=yes COLUMNS=80
  - env: PYTHON_VERSION=3 PYTHONIC=no  SYMPY_VER=1.4 OCT=4.2   DOCTEST=yes COLUMNS=80
  - env: PYTHON_VERSION=3 PYTHONIC=no  SYMPY_VER=1.4 OCT=4.4   DOCTEST=yes COLUMNS=80
  - env: PYTHON_VERSION=2 PYTHONIC=no  SYMPY_VER=1.4 OCT=5     DOCTEST=yes COLUMNS=80
  - env: PYTHON_VERSION=3 PYTHONIC=no  SYMPY_VER=1.4 OCT=5     DOCTEST=yes COLUMNS=80
  - env: PYTHON_VERSION=3 PYTHONIC=no  SYMPY_VER=1.4 OCT=devel DOCTEST=no  COLUMNS=80
  allow_failures:
  - env: PYTHON_VERSION=3 PYTHONIC=no  SYMPY_VER=1.4 OCT=devel DOCTEST=no  COLUMNS=80

before_install:
- docker pull mtmiller/octave:${OCT}

script:
- docker run --cidfile=/tmp/container --detach --init --volume=$PWD:/octsympy:z mtmiller/octave:${OCT} sleep inf
- docker exec $(cat /tmp/container) pip${PYTHON_VERSION} install sympy==${SYMPY_VER}
- docker exec $(cat /tmp/container) make -C octsympy PYTHON=python${PYTHON_VERSION} test
- if [ "x$DOCTEST" = "xyes" ]; then
      docker exec $(cat /tmp/container) octave --eval "pkg install -forge doctest";
      docker exec $(cat /tmp/container) make -C octsympy PYTHON=python${PYTHON_VERSION} doctest;
  fi
- docker stop $(cat /tmp/container)

# TODO:

#- stty cols $COLUMNS rows 40
#- tput cols; stty size

#- if [ "x$PYTHONIC" = "xyes" ]; then
#        export IPC=native;
#    else
#        export IPC=default;
#    fi
#  - octave --path=$TRAVIS_BUILD_DIR/pythonic -W --no-gui --eval "sympref ipc $IPC; r = octsympy_tests; exit(r)";

#  - cat fntests.log

# we can drop numpy after https://gitlab.com/mtmiller/octave-pythonic/issues/14
#  - if [ "x$PYTHONIC" = "xyes" ]; then
#        pip$PYTHON_VERSION install --user numpy;
#    fi
#  - if [ "x$PYTHONIC" = "xyes" ]; then
#        git clone https://gitlab.com/mtmiller/octave-pythonic.git pythonic;
#        pushd pythonic;
#        pwd;
#        autoreconf --install || exit 1;
#        ./configure PYTHON_VERSION=$PYTHON_VERSION && make || exit 1;
#        popd;
#    fi
